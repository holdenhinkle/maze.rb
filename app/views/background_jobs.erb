<nav aria-label="breadcrumb" class="mt-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/admin">Home</a></li>
    <li class="breadcrumb-item active" aria-current="page">All Background Jobs</li>
  </ol>
</nav>
<header>
  <h1>All Background Jobs</h1>
</header>
<section>
  <% if @background_workers_status %>
    <h3>Background Jobs System Status: Running</h3>
    <p>Shutdown</p>
    <p>If you press 'Shutdown', all jobs that are running will be killed and be put back in the queue.</p>
    <h5>Thread Status</h5>
    <p>Maximum number of threads possible (<a href="/admin/settings">see settings</a>): <%= @number_of_threads %></p>
    <% @thread_stats.each_with_index do |thread_stat, index| %>
      <p>Thread <%= index + 1 %>, ID #<%= thread_stat[:id] %>: <%= thread_stat[:status] ? 'Alive' : 'Dead' %> and <%= thread_stat[:mode].capitalize %>
    <% end %>
  <% else %>

  <% end %>
</section>
<section>
  <% @job_statuses.each do |status| %>
    <h2><%= status.capitalize %></h2>
    <table class="table table-hover table-sm">
      <thead class="thead-dark">
        <tr>
          <th scope="col">#</th>
          <th scope="col">ID</th>
          <th scope="col">Job Type</th>
          <th scope="col">Params</th>
          <th scope="col">Status</th>
          <% if status == 'queued' %>
            <th scope="col">Assigned to Worker ID</th>
          <% end %>  
          <% if status == 'running' || status == 'failed' %>
            <th scope="col">Worker ID</th>
            <th scope="col">Thread ID</th>
          <% end %>                      
          <th scope="col">Updated</th>
          <% unless status == 'completed' %>
            <th scope="col"></th>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <% @jobs[status].each_with_index do |job, index| %>
          <tr>
            <th scope='row'><%= index + 1 %></th>
            <td><%= job['id'] %></td>
            <td><%= capitalize_words(underscores_to_spaces(job['job_type'])) %></td>
            <td><%= format_background_job_params(job['params']) %></td>
            <td><%= job['status'].capitalize %></td>
            <% if status == 'queued' %>
              <td><%= job['background_worker_id'] %></td>
            <% end %>  
            <% if status == 'running' || status == 'failed' %>  
              <td><%= job['background_worker_id'] %></td>          
              <td><%= job['background_thread_id'] %></td>
            <% end %>
            <td><%= job['updated'] %></td>
            <% if status == 'queued' %>
              <td scope="col">
                <form action="/admin/background-jobs" method="post">
                  <input type="hidden" name="delete" value="true">
                  <input type="hidden" name="id" value="<%= job['id'] %>">
                  <input type="hidden" name="background_worker_id" value="<%= job['background_worker_id'] %>">
                  <input type="hidden" name="background_thread_id" value="<%= job['background_thread_id'] %>">
                  <button type="type" class="btn btn-danger btn-sm">Delete</button>
                </form>
              </td>
            <% end %>
            <% if status == 'running' %>
              <td scope="col">
                <form action="/admin/background-jobs" method="post">
                  <input type="hidden" name="cancel" value="true">
                  <input type="hidden" name="id" value="<%= job['id'] %>">
                  <input type="hidden" name="background_worker_id" value="<%= job['background_worker_id'] %>">
                  <input type="hidden" name="background_thread_id" value="<%= job['background_thread_id'] %>">
                  <button type="type" class="btn btn-danger btn-sm">Cancel</button>
                </form>
                <form action="/admin/background-jobs" method="post">
                  <input type="hidden" name="delete" value="true">
                  <input type="hidden" name="id" value="<%= job['id'] %>">
                  <input type="hidden" name="background_worker_id" value="<%= job['background_worker_id'] %>">
                  <input type="hidden" name="background_thread_id" value="<%= job['background_thread_id'] %>">
                  <button type="type" class="btn btn-danger btn-sm">Delete</button>
                </form>
              </td>
            <% end %>
            <% if status == 'failed' %>
              <td scope="col">
                <form action="/admin/background-jobs" method="post">
                  <input type="hidden" name="id" value="<%= job['id'] %>">
                  <input type="hidden" name="queue" value="true">
                  <button type="type" class="btn btn-success btn-sm">Try again</button>
                </form>
              </td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    <table>
    <% if @jobs[(status + '_count')][0]['count'].to_i > 10 %>
      <p><a href=""><%= @jobs[(status + '_count')][0]['count'].to_i - 10 %> more results...</a></p>
    <% end %>
  <% end %>
</section>
